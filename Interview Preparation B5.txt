def extract_unpaid_data_from_page(source_page_number):
    """Drills down into 'U-UNPAIDS', scrapes all pages of transactions, and returns."""
    page_data = {"transactions": {}}
    mf.move_to(22, 45)
    mf.send_string("u")
    mf.send_enter()

    # --- FIX: Give the host time to respond ---
    time.sleep(1.5) 
    
    # --- FIX: Check if we actually navigated to the new screen ---
    screen_text = mf.get_screen_text()
    if "UNPAID ITEMS HISTORY" not in screen_text:
        # This happens when there are no unpaid items for the cycle.
        print("  -> Info: No 'UNPAID ITEMS HISTORY' screen found. Likely no unpaids for this cycle.")
        # We did not navigate away, so we can just return the empty dictionary.
        return page_data

    # If we get here, we are confirmed to be on the UNPAID ITEMS HISTORY screen.
    # The first screen's text is already in the 'screen_text' variable.
    
    for i in range(3): # Loop up to 3 times (for current page + 2 PF8 presses)
        # On the first iteration (i=0), we use the text we already have.
        # On subsequent iterations, we get the new page's text.
        if i > 0:
            screen_text = mf.get_screen_text()

        if "accrued_charge" not in page_data:
            accrued_match = re.search(r"ACCRUED CHARGE\s*:\s*([\d,.]+|N/A)", screen_text)
            applied_match = re.search(r"APPLIED CHARGE\s*:\s*([\d,.]+|N/A)", screen_text)
            
            if accrued_match:
                value_str = accrued_match.group(1).strip()
                if value_str.upper() == 'N/A':
                    page_data["accrued_charge"] = 'N/A'
                else:
                    page_data["accrued_charge"] = float(value_str.replace(',', ''))

            if applied_match:
                value_str = applied_match.group(1).strip()
                if value_str.upper() == 'N/A':
                    page_data["applied_charge"] = 'N/A'
                else:
                    page_data["applied_charge"] = float(value_str.replace(',', ''))

        unpaid_matches = re.findall(r"^\s*(\d{2}[A-Z]{3}\d{2}).*? \* .*?([\d,.]+)$", screen_text, re.MULTILINE)
        
        for date_str, amount_str in unpaid_matches:
            amount = float(amount_str.replace(',', ''))
            page_data["transactions"][date_str] = {"amount": amount}

        page_match = re.search(r"PAGE\s+(\d+)\s+OF\s+(\d+)", screen_text)
        if page_match:
            current_page = int(page_match.group(1))
            total_pages = int(page_match.group(2))
            if current_page >= total_pages:
                break 
        else:
            break 
        
        mf.send_pf8()
        time.sleep(0.5)

    mf.send_pf2()
    mf.wait_for_text("SERVICE CHARGE HISTORY")
    return page_data
