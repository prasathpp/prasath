' --- Main Sub to Process Excel Rows ---
Sub ProcessInterestAmendments()
    Dim ws As Worksheet
    Dim i As Long ' Use Long for row numbers
    Dim lastRow As Long
    Dim sortCode As String
    Dim accountNumber As String
    Dim navigationSuccess As Boolean

    ' --- 1. Establish Reflection Connection ---
    If Not ConnectToReflection() Then Exit Sub

    ' --- 2. Define the worksheet ---
    On Error Resume Next
    Set ws = ActiveSheet ' Or ThisWorkbook.Sheets("YourSheetName")
    If ws Is Nothing Then
        MsgBox "Could not set worksheet object.", vbCritical, SCRIPT_TITLE
        Exit Sub
    End If
    On Error GoTo 0

    ' --- 3. Find the last data row ---
    lastRow = ws.Cells(ws.Rows.Count, "A").End(xlUp).Row
    If lastRow < 2 Then
        MsgBox "No data in sheet (Column A).", vbInformation, SCRIPT_TITLE
        Exit Sub
    End If
    Debug.Print "Processing rows from 2 to " & lastRow

    ' --- 4. Loop through data rows ---
    For i = 2 To lastRow
        sortCode = Trim(CStr(ws.Cells(i, "A").Value))
        accountNumber = Trim(CStr(ws.Cells(i, "B").Value))

        If sortCode = "" Or accountNumber = "" Then
            Debug.Print "Skipping row " & i & ": Missing S/C or A/N."
            ws.Cells(i, "G").Value = "Skipped - Missing S/C or A/N"
            ' No explicit 'continue' needed; loop will proceed to Next i
        Else
            ' This block executes only if both sortCode and accountNumber are present
            Debug.Print "Processing Row " & i & ": S/C=" & sortCode & ", A/N=" & accountNumber

            navigationSuccess = NavigateToInterestAmendmentScreen(sortCode, accountNumber)

            If navigationSuccess Then
                Debug.Print "Successfully navigated for A/N: " & accountNumber
                ws.Cells(i, "G").Value = "Navigated - Pending Adjustment"

                MsgBox "Manually verify 'INTEREST AMENDMENTS' screen for S/C: " & sortCode & ", A/N: " & accountNumber & vbCrLf & _
                       "Then click OK to proceed.", vbInformation, SCRIPT_TITLE
                ' TODO: Add adjustment logic here
            Else
                Debug.Print "Navigation FAILED for A/N: " & accountNumber
                ws.Cells(i, "G").Value = "Navigation Failed"
                ' Optionally: Exit For ' to stop on first failure
            End If
        End If ' End check for blank sortCode/accountNumber
    Next i

    MsgBox "Finished processing all rows.", vbInformation, SCRIPT_TITLE

    ' --- 6. Cleanup ---
    ReleaseReflectionObjects
End Sub
