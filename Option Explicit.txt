' Attribute VB_Name = "mod_InterestAmend_FocusCore"
Option Explicit

' --- Reflection COM Objects ---
Dim RApp As Object
Dim RFrame As Object
Dim RView As Object
Dim RTerminal As Object
Dim RScreen As Object

' --- Key Screen Title Constants ---
Private Const SCREEN_APP_MENU As String = "APPLICATION SELECTION MENU"
' ... (other screen constants as needed for navigation later)

' --- Script Title for MsgBoxes ---
Private Const SCRIPT_TITLE As String = "Focused Interest Amendment"

' --- Main Processing Sub ---
Sub ProcessSingleAmendment_Focus()
    Dim ws As Worksheet
    Dim sortCode As String, accountNumber As String, brand As String
    Dim success As Boolean

    ' 1. Connect to Reflection and get the target session
    '    Using the logic that previously succeeded in getting all objects set.
    If Not ConnectAndSetScreen("NTS Back Office - Prod.rd3x") Then
        MsgBox "Failed to connect to Reflection session and set screen object." & vbCrLf & _
               "Ensure 'NTS Back Office - Prod.rd3x' is open.", vbCritical, SCRIPT_TITLE
        Exit Sub
    End If
    Debug.Print "ProcessSingle: Successfully connected and RScreen is set."

    ' 2. Set worksheet and get data for ONE test row
    Set ws = ThisWorkbook.ActiveSheet ' Or ThisWorkbook.Worksheets("SheetName")
    
    ' --- FOR TESTING - Process only one specific row, e.g., row 2 ---
    Dim testRow As Long
    testRow = 2 ' <<<< Change this to your desired test row number
    ' ---

    If ws.Cells(testRow, "A").Value = "" Then
        MsgBox "No data in test row " & testRow & ", Column A.", vbExclamation, SCRIPT_TITLE
        Exit Sub
    End If

    sortCode = Trim(CStr(ws.Cells(testRow, "A").Value))
    accountNumber = Trim(CStr(ws.Cells(testRow, "B").Value))
    brand = UCase(Trim(CStr(ws.Cells(testRow, "C").Value)))

    Debug.Print "-----------------------------------------------------"
    Debug.Print "Processing Excel Row: " & testRow & " | S/C: " & sortCode & " | Acc: " & accountNumber & " | Brand: " & brand

    If sortCode = "" Or accountNumber = "" Or brand = "" Then
        Debug.Print "Skipped row " & testRow & " - Missing data."
        ws.Cells(testRow, "H").Value = "Skipped - Missing Data"
        Exit Sub
    End If

    ' 3. Perform navigation for the current account
    '    (We will build this function next, for now, just confirm connection)
    success = NavigateToTargetScreen_Focus(sortCode, accountNumber, brand) ' Placeholder name

    If success Then
        Debug.Print "Successfully navigated to INTEREST AMENDMENTS screen for row " & testRow
        ws.Cells(testRow, "H").Value = "Navigated - OK"
        MsgBox "PAUSED: On INTEREST AMENDMENTS screen for S/C: " & sortCode & ", A/N: " & accountNumber, vbInformation, SCRIPT_TITLE
        ' Placeholder for actual amendment logic
    Else
        Debug.Print "Navigation FAILED for row " & testRow
        ws.Cells(testRow, "H").Value = "Navigation Failed"
    End If

    CleanUpReflectionObjects_Focus
    MsgBox "Finished processing test row " & testRow, vbInformation, SCRIPT_TITLE
End Sub

' --- PROVEN Connection Logic (based on V8/V9 successful debug) ---
Private Function ConnectAndSetScreen(ByVal targetSessionFilePart As String) As Boolean
    On Error GoTo ErrorHandler
    ConnectAndSetScreen = False

    Debug.Print "ConnectFocus: Attempting GetObject(""Reflection Workspace"")"
    On Error Resume Next ' Allow GetObject to fail if Reflection not running
    Set RApp = GetObject("Reflection Workspace")
    If Err.Number <> 0 Or RApp Is Nothing Then
        Err.Clear
        Debug.Print "ConnectFocus: GetObject(""Reflection Workspace"") FAILED. Ensure Reflection is running."
        Exit Function
    End If
    Debug.Print "ConnectFocus: RApp obtained. TypeName: " & TypeName(RApp)
    On Error GoTo ErrorHandler ' Restore main error handler

    Set RFrame = RApp.GetObject("Frame")
    If RFrame Is Nothing Then Debug.Print "ConnectFocus: RFrame is Nothing.": Exit Function
    Debug.Print "ConnectFocus: RFrame obtained. TypeName: " & TypeName(RFrame)

    If Not RFrame.Visible Then RFrame.Visible = True
    RFrame.Activate ' Brings Reflection Workspace to front

    Debug.Print "ConnectFocus: Attempting RFrame.GetViewByTitleText(""" & targetSessionFilePart & """)..."
    On Error Resume Next ' For GetViewByTitleText
    Set RView = RFrame.GetViewByTitleText(targetSessionFilePart)
    If Err.Number <> 0 Or RView Is Nothing Then
        Err.Clear
        Debug.Print "ConnectFocus: RFrame.GetViewByTitleText FAILED. Error: " & Err.Description
        Exit Function
    End If
    Debug.Print "ConnectFocus: RView obtained. Title: '" & RView.TitleText & "'. TypeName: " & TypeName(RView)
    On Error GoTo ErrorHandler

    ' Skipping RView.Activate as it previously caused Error 438
    ' and RFrame.Activate + GetViewByTitleText should suffice if session is already open.

    Debug.Print "ConnectFocus: Attempting Set RTerminal = RView.Control..."
    On Error Resume Next ' For RView.Control
    Set RTerminal = RView.Control
    If Err.Number <> 0 Or RTerminal Is Nothing Then
        Debug.Print "ConnectFocus: Error on Set RTerminal = RView.Control. Error " & Err.Number & ": " & Err.Description
        Err.Clear
        Exit Function
    End If
    Debug.Print "ConnectFocus: RTerminal obtained. TypeName: " & TypeName(RTerminal)
    On Error GoTo ErrorHandler

    Debug.Print "ConnectFocus: Attempting Set RScreen = RTerminal.Screen..."
    On Error Resume Next ' For RTerminal.Screen
    Set RScreen = RTerminal.Screen
    If Err.Number <> 0 Or RScreen Is Nothing Then
        Debug.Print "ConnectFocus: Error on Set RScreen = RTerminal.Screen. Error " & Err.Number & ": " & Err.Description
        Err.Clear
        Exit Function
    End If
    Debug.Print "ConnectFocus: RScreen obtained. TypeName: " & TypeName(RScreen)
    On Error GoTo ErrorHandler
    
    ' Optional settings - allow them to fail gracefully
    On Error Resume Next
    RTerminal.DisableKeystrokeProductivity = True
    If Err.Number <> 0 Then Debug.Print "ConnectFocus: Info - Error DisableKeystrokeProductivity: " & Err.Description: Err.Clear
    RTerminal.DisableScreenHistory = True
    If Err.Number <> 0 Then Debug.Print "ConnectFocus: Info - Error DisableScreenHistory: " & Err.Description: Err.Clear
    On Error GoTo ErrorHandler

    ConnectAndSetScreen = True
    Debug.Print "ConnectFocus: All core Reflection objects (RApp, RFrame, RView, RTerminal, RScreen) set successfully."
    Exit Function
ErrorHandler:
    Debug.Print "ConnectAndSetScreen Error " & Err.Number & ": " & Err.Description
    ConnectAndSetScreen = False
End Function

Private Sub CleanUpReflectionObjects_Focus()
    Set RScreen = Nothing
    Set RTerminal = Nothing
    Set RView = Nothing
    Set RFrame = Nothing
    Set RApp = Nothing
    Debug.Print "Focused Reflection objects released."
End Sub

' --- Placeholder for Navigation Logic ---
Private Function NavigateToTargetScreen_Focus(ByVal sc As String, ByVal acct As String, ByVal brnd As String) As Boolean
    Dim confirmCode As String
    Dim l_loop As Long ' For STAR loop if needed, though might not be for this direct nav

    NavigateToTargetScreen_Focus = False ' Default to failure

    If RScreen Is Nothing Then
        Debug.Print "NavigateFocus: RScreen object is not available. Cannot navigate."
        Exit Function
    End If

    ' --- Determine Confirmation Code based on Brand ---
    Select Case brnd
        Case "RBS", "RBG", "RBI", "VIR": confirmCode = "PRCIR#T#"
        Case "NWB", "CTS", "NWO", "IOM": confirmCode = "PRCIN#T#"
        Case "UBN": confirmCode = "PRCIJ#T#"
        Case "UBR": confirmCode = "PRCIK#T#"
        Case Else
            Debug.Print "NavigateFocus: Invalid Brand '" & brnd & "'"
            Exit Function
    End Select
    Debug.Print "NavigateFocus: Using confirm code: " & confirmCode

    ' --- Step 1: Ensure on APPLICATION SELECTION MENU ---
    ' Coordinates for SCREEN_APP_MENU: R1, C28
    If Not VerifyScreen_Focus(SCREEN_APP_MENU, 1, 28) Then
         Debug.Print "NavigateFocus: Not starting on " & SCREEN_APP_MENU & "."
         MsgBox "Macro must start on '" & SCREEN_APP_MENU & "'. Please manually navigate and restart.", vbExclamation, SCRIPT_TITLE
         Exit Function
    End If
    Debug.Print "NavigateFocus: Confirmed on " & SCREEN_APP_MENU

    ' --- Step 2: TERM ALL ---
    ' Coordinates for command line: R21, C13
    Call SendData_Focus("TERM ALL", 21, 13, True) ' True to send Transmit
    Debug.Print "NavigateFocus: Sent TERM ALL"
    ' After TERM ALL, screen might clear or stay. Expect it to be ready for next command.
    ' A short explicit wait might be good here if host is slow after TERM ALL.
    Call WaitReady_Focus(1000) ' Wait 1 second

    ' --- Step 3: Brand Code ---
    Call SendData_Focus(confirmCode, 21, 13, True)
    Debug.Print "NavigateFocus: Sent " & confirmCode
    ' Check for "Command not recognized" (R20, C36, L22)
    If VerifyScreen_Focus("Command not recognized", 20, 36, 22) Then
        Debug.Print "NavigateFocus: Brand code '" & confirmCode & "' not recognized."
        Exit Function
    End If
    ' Expected: OPT_HANDLER (R2,C28 for "OPTION HANDLER...", also check for "SP2001" on R2)
    If Not VerifyScreen_Focus(SCREEN_OPT_HANDLER, 2, 28) Then
        If Not (InStr(1, UCase(Trim(RScreen.GetText(2, 1, 80))), "SP2001") > 0 And VerifyScreen_Focus(SCREEN_OPT_HANDLER, 2, 28)) Then
             Debug.Print "NavigateFocus: Did not reach " & SCREEN_OPT_HANDLER
             Exit Function
        End If
    End If
    Debug.Print "NavigateFocus: On " & SCREEN_OPT_HANDLER

    ' --- Step 4: Option 19 ---
    ' Coordinates for option input: R21, C16
    Call SendData_Focus("19", 21, 16, True)
    Debug.Print "NavigateFocus: Sent 19"
    ' Expected: BO_SYSTEM (R1,C7)
    If Not VerifyScreen_Focus(SCREEN_BO_SYSTEM, 1, 7) Then Exit Function
    Debug.Print "NavigateFocus: On " & SCREEN_BO_SYSTEM

    ' --- Step 5: Option 01 ---
    ' Coordinates for option input: R22, C16
    Call SendData_Focus("01", 22, 16, True)
    Debug.Print "NavigateFocus: Sent 01"
    ' Expected: MASTER_INDEX (R1,C28)
    If Not VerifyScreen_Focus(SCREEN_MASTER_INDEX, 1, 28) Then Exit Function
    Debug.Print "NavigateFocus: On " & SCREEN_MASTER_INDEX

    ' --- Step 6: Master Index - Action 20, Sort Code ---
    ' Coords: Action R22,C8; SortCode R22,C74
    Call WaitReady_Focus(100) ' Settle before multi-part input
    RScreen.PutText2 "20", 22, 8
    RScreen.PutText2 Format(sc, "000000"), 22, 74
    Call SendKey_Focus(ControlKeyCode_Transmit, 1000) ' Send Transmit, wait 1s
    Debug.Print "NavigateFocus: Sent 20 + S/C " & sc
    ' Expected: FILE_MAINT_IDX (R1,C21)
    If Not VerifyScreen_Focus(SCREEN_FILE_MAINT_IDX, 1, 21) Then Exit Function
    Debug.Print "NavigateFocus: On " & SCREEN_FILE_MAINT_IDX

    ' --- Step 7: File Maint Idx - Action 20, Account Number ---
    ' Coords: Action R22,C8; Account R22,C21
    Call WaitReady_Focus(100)
    RScreen.PutText2 "20", 22, 8
    RScreen.PutText2 Format(acct, "00000000"), 22, 21
    Call SendKey_Focus(ControlKeyCode_Transmit, 1000)
    Debug.Print "NavigateFocus: Sent 20 + A/N " & acct
    ' Expected: INTERNAL_TXNS (R1,C19)
    If Not VerifyScreen_Focus(SCREEN_INTERNAL_TXNS, 1, 19) Then Exit Function
    Debug.Print "NavigateFocus: On " & SCREEN_INTERNAL_TXNS

    ' --- Step 8: Internal Txns - Action 04 ---
    ' Coords: Action R22,C8
    Call SendData_Focus("04", 22, 8, True)
    Debug.Print "NavigateFocus: Sent 04"
    ' Target screen: INTEREST_AMENDMENTS (R1, C30 estimate - VERIFY THIS)
    If Not VerifyScreen_Focus(SCREEN_INTEREST_AMENDMENTS, 1, 30) Then
        ' Fallback: Check for "INTEREST DETAILS" on Line 2 (R2, C30 estimate)
        If Not VerifyScreen_Focus("INTEREST DETAILS", 2, 30) Then
            Debug.Print "NavigateFocus: Did not reach " & SCREEN_INTEREST_AMENDMENTS
            Exit Function
        End If
    End If
    Debug.Print "NavigateFocus: Successfully reached " & SCREEN_INTEREST_AMENDMENTS

    NavigateToTargetScreen_Focus = True ' Navigation Success!
End Function

' --- Minimalist Screen Interaction Helpers (renamed with _Focus suffix) ---
Private Sub WaitReady_Focus(Optional settleTimeMs As Long = 200, Optional timeoutMs As Long = 10000)
    If RScreen Is Nothing Then Exit Sub
    Dim startTime As Date: startTime = Now
    Do While RScreen.OIA.XStatus <> 0
        If DateDiff("s", startTime, Now) * 1000 > timeoutMs Then
            Debug.Print "WaitReady_Focus: Timeout XStatus=0."
            Exit Do
        End If
        RScreen.WaitForHostSettle 100, 50: DoEvents
    Loop
    RScreen.WaitForHostSettle settleTimeMs, timeoutMs
End Sub

Private Function VerifyScreen_Focus(expectedText As String, rowNum As Long, colNum As Long, Optional ByVal length As Long = 0) As Boolean
    If RScreen Is Nothing Then VerifyScreen_Focus = False: Exit Function
    Call WaitReady_Focus(100)
    If length = 0 Then length = Len(expectedText)
    Dim actualText As String: actualText = Trim(RScreen.GetText(rowNum, colNum, length))
    If UCase(actualText) = UCase(expectedText) Then
        VerifyScreen_Focus = True
    Else
        VerifyScreen_Focus = False
        Debug.Print "VerifyScreen_Focus FAILED: Expected '" & expectedText & "', Found '" & actualText & "' at R" & rowNum & "C" & colNum & "L" & length
    End If
End Function

Private Sub SendData_Focus(data As String, rowNum As Long, colNum As Long, Optional sendTransmit As Boolean = True)
    If RScreen Is Nothing Then Exit Sub
    Call WaitReady_Focus(100)
    RScreen.PutText2 data, rowNum, colNum
    If sendTransmit Then
        RScreen.SendControlKey ControlKeyCode_Transmit
        Call WaitReady_Focus(500) ' Increased default wait after transmit
    End If
End Sub

Private Sub SendKey_Focus(keyCode As Long, Optional waitAfterMs As Long = 500) ' Renamed to avoid conflict
    If RScreen Is Nothing Then Exit Sub
    Call WaitReady_Focus(100)
    RScreen.SendControlKey keyCode
    Call WaitReady_Focus(waitAfterMs)
End Sub
