' Attribute VB_Name = "mod_BackOffice_InterestAmendments_Setup_V6"
Option Explicit

' --- Attachmate Reflection Object Declarations ---
Public objReflectionApp As Object
Public objFrame As Object
Public objView As Object
Public objTerminal As Object
Public objScreen As Object

' --- Constants for this specific automation ---
Private Const TARGET_SESSION_ID_PART As String = "NTS Back Office - Prod.rd3x"

Private Const SCREEN_APP_MENU As String = "APPLICATION SELECTION MENU"
Private Const SCREEN_APP_MENU_ROW As Long = 1       ' <<< ENSURE THIS IS CORRECTLY DEFINED
Private Const SCREEN_APP_MENU_COL As Long = 28       ' <<< ENSURE THIS IS CORRECTLY DEFINED
Private Const SCREEN_APP_MENU_LENGTH As Long = 30    ' <<< ENSURE THIS IS CORRECTLY DEFINED

Private Const CMD_TERM_ALL As String = "TERM ALL"
Private Const CMD_TERM_ALL_ROW As Long = 21
Private Const CMD_TERM_ALL_COL As Long = 13

Private Const MAX_PAGEDOWN_ATTEMPTS As Integer = 10
Private Const SCRIPT_TITLE As String = "Back Office - TERM ALL Entry V6"


' --- Main Entry Point (same, just calls _V6 connect function) ---
Sub PerformTermAllEntry_V6()
    On Error GoTo ErrorHandler
    Dim success As Boolean

    success = ConnectAndActivateReflectionSession_V6(TARGET_SESSION_ID_PART)
    If Not success Then
        MsgBox "Failed to connect/activate Reflection session: '" & TARGET_SESSION_ID_PART & "'." & vbCrLf & _
               "Ensure session is open. Check Immediate Window for debug details.", vbCritical, SCRIPT_TITLE
        GoTo CleanupAndExit
    End If
    Debug.Print SCRIPT_TITLE & ": Successfully connected to and activated session: " & objView.TitleText

    ' --- THIS IS THE LINE WHERE THE ERROR OCCURRED ---
    ' Ensure all constants SCREEN_APP_MENU, SCREEN_APP_MENU_ROW, SCREEN_APP_MENU_COL, SCREEN_APP_MENU_LENGTH are defined
    success = NavigateToScreen_V6(SCREEN_APP_MENU, SCREEN_APP_MENU_ROW, SCREEN_APP_MENU_COL, SCREEN_APP_MENU_LENGTH, MAX_PAGEDOWN_ATTEMPTS)
    
    If Not success Then
        MsgBox "Failed to navigate to '" & SCREEN_APP_MENU & "'.", vbExclamation, SCRIPT_TITLE
        GoTo CleanupAndExit
    End If
    Debug.Print SCRIPT_TITLE & ": Successfully navigated to: " & SCREEN_APP_MENU

    Call WaitHostSettle_V6(1000)
    objScreen.PutText2 CMD_TERM_ALL, CMD_TERM_ALL_ROW, CMD_TERM_ALL_COL
    Debug.Print SCRIPT_TITLE & ": Entered command: '" & CMD_TERM_ALL & "' at R" & CMD_TERM_ALL_ROW & "C" & CMD_TERM_ALL_COL
    
    objScreen.SendControlKey ControlKeyCode_Transmit
    Debug.Print SCRIPT_TITLE & ": Sent Transmit key."
    
    Call WaitHostSettle_V6(5000)
    MsgBox "'" & CMD_TERM_ALL & "' entered successfully.", vbInformation, SCRIPT_TITLE

CleanupAndExit:
    Set objScreen = Nothing
    Set objTerminal = Nothing
    Set objView = Nothing
    Set objFrame = Nothing
    Set objReflectionApp = Nothing
    Exit Sub
ErrorHandler:
    MsgBox "Error in '" & SCRIPT_TITLE & "':" & vbCrLf & Err.Number & ": " & Err.Description, vbCritical, SCRIPT_TITLE
    Resume CleanupAndExit
End Sub

' --- Helper Function: Connects and activates session (Version 6 - from previous correct response) ---
Private Function ConnectAndActivateReflectionSession_V6(ByVal uniquePartOfSessionTitle As String) As Boolean
    On Error GoTo ConnectErrorHandler
    ConnectAndActivateReflectionSession_V6 = False

    Dim tempView As Object 
    Dim method1Succeeded As Boolean: method1Succeeded = False

    Debug.Print "Connect_V6: Attempting Method 1: GetObject(""Reflection Workspace"")"
    On Error Resume Next
    Set objReflectionApp = GetObject("Reflection Workspace")
    If Err.Number = 0 And Not objReflectionApp Is Nothing Then
        method1Succeeded = True
        Debug.Print "Connect_V6: Method 1 SUCCEEDED setting objReflectionApp."
    Else
        Err.Clear
        Debug.Print "Connect_V6: Method 1 failed. Trying Method 2 (GetObject for ""ReflectionWorkspace.Application"")..."
        Set objReflectionApp = GetObject(, "ReflectionWorkspace.Application")
        If Err.Number <> 0 Or objReflectionApp Is Nothing Then
            Err.Clear
            Debug.Print "Connect_V6: Method 2 failed. Trying Method 3 (CreateObject for ""ReflectionWorkspace.Application"")..."
            Set objReflectionApp = CreateObject("ReflectionWorkspace.Application")
            If Err.Number <> 0 Or objReflectionApp Is Nothing Then
                Err.Clear
                Debug.Print "Connect_V6: Method 3 also failed. Cannot obtain Reflection Application object."
                GoTo FinalConnectErrorHandling
            Else
                Debug.Print "Connect_V6: Method 3 SUCCEEDED."
            End If
        Else
            Debug.Print "Connect_V6: Method 2 SUCCEEDED."
        End If
    End If
    On Error GoTo ConnectErrorHandler


    If objReflectionApp Is Nothing Then Exit Function
    Debug.Print "Connect_V6: TypeName(objReflectionApp) is: " & TypeName(objReflectionApp)

    If method1Succeeded Then
        On Error Resume Next
        Set objFrame = objReflectionApp.GetObject("Frame")
        If Err.Number <> 0 Or objFrame Is Nothing Then
            Err.Clear
            Debug.Print "Connect_V6: Error getting Frame from objReflectionApp (Method 1). Error: " & Err.Description
            Dim tempAppForFrame As Object
            Set tempAppForFrame = GetObject(, "ReflectionWorkspace.Application")
            If Not tempAppForFrame Is Nothing Then
                Set objFrame = tempAppForFrame.GetObject("Frame")
                Debug.Print "Connect_V6: Got Frame using fallback."
                Set tempAppForFrame = Nothing
            End If
            If objFrame Is Nothing Then Debug.Print "Connect_V6: Still couldn't get Frame (Method 1 path).": Exit Function
        Else
            Debug.Print "Connect_V6: Successfully got Frame (Method 1 path)."
        End If
        On Error GoTo ConnectErrorHandler
    Else
        Do While objReflectionApp.IsInitialized = False
            objReflectionApp.Wait 200
        Loop
        Set objFrame = objReflectionApp.GetObject("Frame")
    End If

    If objFrame Is Nothing Then Debug.Print "Connect_V6: Frame object is Nothing.": Exit Function
    Debug.Print "Connect_V6: objFrame is set. TypeName(objFrame) is: " & TypeName(objFrame)

    If Not objFrame.Visible Then objFrame.Visible = True
    objFrame.Activate
    Debug.Print "Connect_V6: Frame Visible/Activated."

    Debug.Print "Connect_V6: Attempting to get objFrame.ActiveView..."
    On Error Resume Next 
    Set objView = objFrame.ActiveView
    If Err.Number <> 0 Or objView Is Nothing Then
        Err.Clear
        Debug.Print "Connect_V6: Could not get objFrame.ActiveView or it's Nothing. Error: " & Err.Description
        GoTo FinalConnectErrorHandling 
    Else
        Debug.Print "Connect_V6: objFrame.ActiveView obtained. Title: '" & objView.TitleText & "'"
        If InStr(1, objView.TitleText, uniquePartOfSessionTitle, vbTextCompare) > 0 Then
            Debug.Print "Connect_V6: ActiveView matches target session."
        Else
            Debug.Print "Connect_V6: ActiveView ('" & objView.TitleText & "') does NOT match target ('" & uniquePartOfSessionTitle & "')."
            Set objView = Nothing 
            Exit Function 
        End If
    End If
    On Error GoTo ConnectErrorHandler


    If objView Is Nothing Then 
        Debug.Print "Connect_V6: objView is Nothing after attempting to get ActiveView."
        Exit Function
    End If

    objView.Activate
    Set objTerminal = objView.Control
    Set objScreen = objTerminal.Screen

    If objTerminal Is Nothing Or objScreen Is Nothing Then
        Debug.Print "Connect_V6: Failed to get Terminal/Screen from view '" & objView.TitleText & "'."
        Exit Function
    End If

    objTerminal.DisableKeystrokeProductivity = True
    objTerminal.DisableScreenHistory = True

    ConnectAndActivateReflectionSession_V6 = True
    Debug.Print "Connect_V6: Successfully targeted session '" & objView.TitleText & "'."
    Exit Function

FinalConnectErrorHandling:
    Debug.Print "Connect_V6: Unrecoverable error in obtaining Reflection objects."
    ConnectAndActivateReflectionSession_V6 = False
    If Err.Number = 0 Then Exit Function

ConnectErrorHandler:
    Debug.Print "Connect_V6: Error (captured by ConnectErrorHandler) - " & Err.Number & ": " & Err.Description
    ConnectAndActivateReflectionSession_V6 = False
End Function

' --- Helper Subs (_V6) ---
Private Sub WaitHostSettle_V6(Optional ByVal settleTimeoutMilliseconds As Long = 3000)
    If objScreen Is Nothing Then Debug.Print "WaitHostSettle_V6: objScreen is Nothing.": Exit Sub
    Dim startTime As Date: startTime = Now
    Do While objScreen.OIA.XStatus <> 0
        If DateDiff("s", startTime, Now) * 1000 > settleTimeoutMilliseconds Then
            Debug.Print "WaitHostSettle_V6: Timeout XStatus."
            Exit Do
        End If
        objScreen.WaitForHostSettle 100, 50: DoEvents
    Loop
    objScreen.WaitForHostSettle 500, 200
    Debug.Print "WaitHostSettle_V6: Screen ready (XStatus=" & objScreen.OIA.XStatus & ")."
End Sub

Private Function NavigateToScreen_V6(ByVal targetScreenText As String, _
                                  ByVal targetRow As Long, ByVal targetCol As Long, ByVal targetLength As Long, _
                                  ByVal maxAttempts As Integer) As Boolean
    On Error Resume Next
    NavigateToScreen_V6 = False
    If objScreen Is Nothing Then Debug.Print "Navigate_V6: objScreen is Nothing.": Exit Function

    Dim attempts As Integer, currentScreenContent As String
    For attempts = 1 To maxAttempts
        Call WaitHostSettle_V6(2000)
        currentScreenContent = Trim(objScreen.GetText(targetRow, targetCol, targetLength))
        Debug.Print "Navigate_V6: Attempt " & attempts & " - Text at R" & targetRow & "C" & targetCol & ": '" & currentScreenContent & "'"
        If UCase(currentScreenContent) = UCase(targetScreenText) Then
            NavigateToScreen_V6 = True: Exit Function
        End If
        If attempts < maxAttempts Then
            objScreen.SendControlKey ControlKeyCode_PageDown
            Debug.Print "Navigate_V6: Sent PageDown."
        End If
    Next attempts
    Debug.Print "Navigate_V6: Failed to reach '" & targetScreenText & "'."
End Function
